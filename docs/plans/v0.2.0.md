# v0.2.0 - 局域网发现

**目标**: 同一局域网内的用户可以看到彼此。核心网络层开始工作。

## 依赖

- v0.1.0 (项目基础)

## 任务

### 0.2.1 IPMsg 协议实现

创建 `IPMsgProtocol` 模块,实现数据包编解码:

```swift
// Sources/IPMsgProtocol/IPMsgPacket.swift
public struct IPMsgPacket {
    public let version: UInt32
    public let packetNo: UInt32
    public let sender: String
    public let hostname: String
    public let command: UInt32
    public let payload: String

    public func encode() -> Data {
        let packet = "\(version):\(packetNo):\(sender):\(hostname):\(command):\(payload)"
        return packet.data(using: .utf8)!
    }

    public static func decode(_ data: Data) throws -> IPMsgPacket {
        guard let string = String(data: data, encoding: .utf8) else {
            throw IPMsgError.invalidEncoding
        }

        let parts = string.split(separator: ":", maxSplits: 5)
        guard parts.count == 6 else {
            throw IPMsgError.malformedPacket
        }

        return IPMsgPacket(
            version: UInt32(parts[0]) ?? 1,
            packetNo: UInt32(parts[1]) ?? 0,
            sender: String(parts[2]),
            hostname: String(parts[3]),
            command: UInt32(parts[4]) ?? 0,
            payload: String(parts[5])
        )
    }

    public var commandType: IPMsgCommand {
        IPMsgCommand(rawValue: command & 0xFF) ?? .NOOPERATION
    }
}

// Sources/IPMsgProtocol/IPMsgCommand.swift
public enum IPMsgCommand: UInt32 {
    case NOOPERATION = 0x00
    case BR_ENTRY = 0x01
    case BR_EXIT = 0x02
    case ANSENTRY = 0x03
    case BR_ABSENCE = 0x04
    case SENDMSG = 0x20
    case RECVMSG = 0x21
    case GETFILEDATA = 0x60
    case RELEASEFILES = 0x61
}

// 选项标志
public let IPMSG_ABSENCEOPT: UInt32 = 0x100
public let IPMSG_SERVEROPT: UInt32 = 0x200
public let IPMSG_SENDCHECKOPT: UInt32 = 0x100
public let IPMSG_SECRETOPT: UInt32 = 0x200
```

### 0.2.2 UDP 广播服务

实现 UDP 发现服务(使用 BSD Socket):

```swift
// Sources/IPMsgProtocol/UDPDiscoveryService.swift
public actor UDPDiscoveryService {
    private let port: UInt16 = 2425
    private var sockfd: Int32 = -1

    public func start() async throws {
        // 创建 UDP socket
        sockfd = socket(AF_INET, SOCK_DGRAM, 0)
        guard sockfd >= 0 else {
            throw IPMsgError.networkUnavailable
        }

        // 启用广播
        var broadcast: Int32 = 1
        setsockopt(sockfd, SOL_SOCKET, SO_BROADCAST, &broadcast, socklen_t(MemoryLayout<Int32>.size))

        // 绑定端口监听
        var addr = sockaddr_in()
        addr.sin_family = sa_family_t(AF_INET)
        addr.sin_port = port.bigEndian
        addr.sin_addr.s_addr = INADDR_ANY.bigEndian

        // 绑定并监听
        // ...

        // 启动接收循环
        startReceiving()
    }

    public func broadcastEntry() async throws {
        let packet = IPMsgPacket(
            version: 1,
            packetNo: generatePacketNo(),
            sender: LocalUser.shared.nickname,
            hostname: LocalUser.shared.hostname,
            command: IPMsgCommand.BR_ENTRY.rawValue,
            payload: LocalUser.shared.group ?? ""
        )

        try await broadcast(packet)
    }

    private func broadcast(_ packet: IPMsgPacket) async throws {
        var addr = sockaddr_in()
        addr.sin_family = sa_family_t(AF_INET)
        addr.sin_port = port.bigEndian
        addr.sin_addr.s_addr = inet_addr("255.255.255.255")

        let data = packet.encode()
        // 发送数据...
    }
}
```

### 0.2.3 用户发现 Provider

创建 @Observable 服务管理在线用户:

```swift
// Sources/FluxQServices/DiscoveryService.swift
@Observable
public final class DiscoveryService {
    private let udpService: UDPDiscoveryService
    private let modelContext: ModelContext

    public var onlineUsers: [User] = []

    public func start() async throws {
        try await udpService.start()
        try await udpService.broadcastEntry()

        // 监听用户发现事件
        for await event in udpService.discoveryEvents {
            await handleDiscoveryEvent(event)
        }
    }

    private func handleDiscoveryEvent(_ event: DiscoveryEvent) async {
        switch event {
        case .userOnline(let packet):
            await addOrUpdateUser(packet)
        case .userOffline(let packet):
            await removeUser(packet)
        }
    }
}
```

### 0.2.4 平台网络工具

实现获取本地网络信息:

```swift
// Sources/IPMsgProtocol/NetworkUtils.swift
public struct NetworkUtils {
    public static func getLocalIPAddress() -> String? {
        var address: String?
        var ifaddr: UnsafeMutablePointer<ifaddrs>?

        guard getifaddrs(&ifaddr) == 0 else { return nil }
        defer { freeifaddrs(ifaddr) }

        var ptr = ifaddr
        while ptr != nil {
            let interface = ptr!.pointee
            let addrFamily = interface.ifa_addr.pointee.sa_family

            if addrFamily == UInt8(AF_INET) {
                let name = String(cString: interface.ifa_name)
                if name == "en0" {  // Wi-Fi interface
                    var hostname = [CChar](repeating: 0, count: Int(NI_MAXHOST))
                    getnameinfo(interface.ifa_addr, socklen_t(interface.ifa_addr.pointee.sa_len),
                              &hostname, socklen_t(hostname.count),
                              nil, socklen_t(0), NI_NUMERICHOST)
                    address = String(cString: hostname)
                }
            }
            ptr = interface.ifa_next
        }

        return address
    }

    public static func getBroadcastAddress() -> String {
        // 简单实现: 返回 255.255.255.255
        return "255.255.255.255"
    }
}
```

### 0.2.5 在线用户 UI

实现发现页面:

```swift
// App/FluxQ/Views/DiscoveryView.swift
struct DiscoveryView: View {
    @Environment(DiscoveryService.self) private var discoveryService

    var body: some View {
        NavigationStack {
            List(discoveryService.onlineUsers) { user in
                UserRow(user: user)
            }
            .navigationTitle("在线用户")
            .refreshable {
                await discoveryService.refresh()
            }
            .task {
                try? await discoveryService.start()
            }
        }
    }
}

struct UserRow: View {
    let user: User

    var body: some View {
        HStack {
            Circle()
                .fill(user.isOnline ? Color.green : Color.gray)
                .frame(width: 10, height: 10)

            VStack(alignment: .leading) {
                Text(user.nickname)
                    .font(.headline)

                Text(user.ipAddress)
                    .font(.caption)
                    .foregroundStyle(.secondary)
            }

            Spacer()

            if let group = user.group {
                Text(group)
                    .font(.caption)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(Color.blue.opacity(0.2))
                    .clipShape(Capsule())
            }
        }
    }
}
```

### 0.2.6 用户状态管理

实现状态切换:

```swift
extension DiscoveryService {
    public func updateStatus(_ status: UserStatus) async throws {
        LocalUser.shared.status = status

        let command = IPMsgCommand.BR_ABSENCE.rawValue |
                     (status == .away ? IPMSG_ABSENCEOPT : 0)

        let packet = IPMsgPacket(
            version: 1,
            packetNo: generatePacketNo(),
            sender: LocalUser.shared.nickname,
            hostname: LocalUser.shared.hostname,
            command: command,
            payload: ""
        )

        try await udpService.broadcast(packet)
    }
}
```

添加设置页面状态切换:

```swift
struct SettingsView: View {
    @Environment(DiscoveryService.self) private var discoveryService
    @State private var selectedStatus: UserStatus = .online

    var body: some View {
        Form {
            Section("状态") {
                Picker("当前状态", selection: $selectedStatus) {
                    Text("在线").tag(UserStatus.online)
                    Text("离开").tag(UserStatus.away)
                    Text("忙碌").tag(UserStatus.busy)
                }
                .onChange(of: selectedStatus) { _, newStatus in
                    Task {
                        try? await discoveryService.updateStatus(newStatus)
                    }
                }
            }
        }
    }
}
```

## 验证

- [ ] 启动时发送 BR_ENTRY UDP 广播
- [ ] 接收其他用户的 BR_ENTRY 并回复 ANS_ENTRY
- [ ] 在线用户列表显示局域网内的用户
- [ ] 显示用户昵称/IP/部门/状态
- [ ] 下拉刷新可以手动触发重新发现
- [ ] 更改状态会广播 BR_ABSENCE
- [ ] 退出时发送 BR_EXIT

## 交付物

在同一局域网的两台设备上打开应用,它们会自动发现彼此并显示在"发现"标签中。

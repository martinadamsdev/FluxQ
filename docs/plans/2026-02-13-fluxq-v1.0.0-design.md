# FluxQ v1.0.0 设计文档

**日期**: 2026-02-13
**版本**: v1.0.0
**状态**: 已批准

## 项目概述

FluxQ 是一款使用 Swift 和 SwiftUI 开发的跨平台即时通讯应用,完全复刻飞秋(FeiQ)的功能,支持 IPMsg 和飞鸽协议,在 Apple 全平台(macOS、iOS、iPadOS、watchOS)上运行。UI 设计借鉴 WeChat 的核心布局,同时使用 Apple 原生组件保持平台一致性。

## 核心目标

### v1.0.0 目标
- 完整实现 IPMsg 协议,与飞秋/飞鸽客户端互操作
- 支持局域网用户发现、一对一聊天、群聊
- 支持文件/文件夹传输(含断点续传)
- 支持截图和图片消息
- 完整的联系人管理和系统集成
- Apple 全平台支持(macOS 14+, iOS 17+, iPadOS 17+, watchOS 10+)

## 技术栈

| 层级 | 技术选择 | 版本要求 |
|------|---------|---------|
| UI 框架 | SwiftUI | macOS 14+, iOS 17+ |
| 数据持久化 | SwiftData + CloudKit | macOS 14+, iOS 17+ |
| 网络层 | Network.framework + BSD Socket | macOS 14+, iOS 17+ |
| 状态管理 | @Observable + SwiftUI | 原生支持 |
| 并发 | Swift Concurrency (async/await) | 原生支持 |
| 路由 | NavigationStack + NavigationPath | iOS 16+ |

## 系统版本要求

- **macOS**: 14 (Sonoma) 或更高
- **iOS**: 17 或更高
- **iPadOS**: 17 或更高
- **watchOS**: 10 或更高

**说明**: 相比原 Flutter 版本的系统要求(macOS 13/iOS 16),提高版本要求以使用 SwiftData 和 CloudKit 的现代 API。

## 架构设计

### 整体架构

采用 **模块化 + 多 Target** 架构:

```
FluxQ/
├── App/                        # 应用层
│   ├── FluxQ/                 # 主应用 (macOS/iOS/iPadOS)
│   └── FluxQWatch/            # watchOS 应用(轻量级通知中心)
│
├── Modules/                    # 本地 Swift Packages
│   ├── IPMsgProtocol/         # IPMsg 协议实现
│   ├── FluxQModels/           # 数据模型
│   ├── FluxQServices/         # 业务服务
│   └── FluxQUI/               # 共享 UI 组件
│
└── Tests/                      # 集成测试
```

### 模块职责划分

#### 1. IPMsgProtocol 模块

**职责**: 实现完整的 IPMsg 协议栈

**核心组件**:
- `UDPDiscoveryService`: UDP 广播发现(BR_ENTRY, BR_EXIT, ANS_ENTRY)
- `TCPMessenger`: TCP 消息传输(SENDMSG, RECVMSG)
- `IPMsgPacket`: 数据包编解码
- `IPMsgCommand`: 命令字定义
- `CryptoService`: 加密支持(RSA, AES-256)

**关键实现**:
- 使用 Network.framework 处理高层网络逻辑
- 使用 BSD Socket 精确控制 UDP 广播地址和 SO_BROADCAST 选项
- 支持 IPMsg v1 和 v3 协议格式
- 兼容 FeiQ 的编码格式(UTF-8/GBK 自动检测)

#### 2. FluxQModels 模块

**职责**: SwiftData 数据模型

**核心模型**:
- `User`: 用户信息(昵称、IP、状态、分组)
- `Message`: 消息(内容、状态、时间戳、附件)
- `Conversation`: 会话(私聊/群聊、参与者、未读数)
- `Group`: 群组(名称、成员、创建者)
- `FileTransfer`: 文件传输(进度、状态、断点续传)

**数据持久化**:
- 使用 SwiftData 自动管理对象关系
- CloudKit 同步(可选,为 v4.0.0 云端 IM 做准备)
- 自动迁移和版本控制

#### 3. FluxQServices 模块

**职责**: 业务逻辑层

**核心服务**:
- `DiscoveryService`: 用户发现和在线状态管理
- `MessageService`: 消息收发、离线队列、重试机制
- `FileTransferService`: 文件传输、分块上传、断点续传
- `EncryptionService`: 端到端加密
- `NotificationService`: 系统通知

#### 4. FluxQUI 模块

**职责**: 共享 UI 组件

**核心组件**:
- `ChatBubble`: 消息气泡(类似 WeChat 风格)
- `UserAvatar`: 用户头像
- `ConversationRow`: 会话列表行
- `Theme`: 主题系统(浅色/深色/自定义)

## UI 设计

### 设计原则

1. **借鉴 WeChat 核心布局**: 采用熟悉的 TabView 结构和聊天气泡样式
2. **使用原生组件**: SF Symbols、原生控件,符合 Apple HIG
3. **平台适配**: macOS 三栏布局,iOS/iPadOS 标签栏,watchOS 简化通知

### 主界面结构

**TabView 结构**(类似 WeChat):
1. **消息**: 会话列表,显示最近消息和未读角标
2. **通讯录**: 联系人分组管理
3. **发现**: 在线用户列表(局域网发现)
4. **我**: 个人设置和配置

### 核心视图

#### 1. 消息列表 (ConversationListView)

- 按最后消息时间倒序排列
- 显示头像、昵称、消息预览、时间、未读角标
- 下拉刷新
- 右上角 "+" 按钮创建群聊

#### 2. 聊天界面 (ChatView)

- 类似 WeChat 的气泡样式:
  - 左侧: 收到的消息(灰色背景)
  - 右侧: 发送的消息(绿色背景)
- 消息状态指示器(发送中/已送达/已读)
- 输入栏: 语音、文本、表情、更多(文件/图片)
- 支持长按消息复制/删除

#### 3. 发现页面 (DiscoveryView)

- 显示局域网在线用户
- 显示 IP 地址、部门、在线状态
- 下拉刷新手动触发重新发现
- 点击用户进入聊天

#### 4. 平台特定界面

**macOS**:
- 使用 NavigationSplitView 三栏布局
- 联系人列表(左) | 会话列表(中) | 聊天详情(右)
- 支持系统托盘、菜单栏图标

**iOS/iPadOS**:
- TabView + NavigationStack
- iPad 自适应布局(竖屏/横屏)

**watchOS**:
- 简化的消息通知列表
- 快速回复和预设消息
- 通过 Watch Connectivity 与 iPhone 同步

## IPMsg 协议实现

### 数据包格式

```
版本号:包编号:发送者:主机名:命令字:附加数据
```

**示例**:
```
1:100:Alice:MacBook-Pro:33:Hello World
```

**字段说明**:
- **版本号**: 1 (IPMSG_VERSION)
- **包编号**: 递增的包序号(用于去重和确认)
- **发送者**: 用户昵称
- **主机名**: 设备主机名
- **命令字**: 低8位=命令类型,高24位=选项标志
- **附加数据**: 消息内容或扩展信息

### 核心命令字

| 命令 | 值 | 说明 | 协议 |
|------|-----|------|------|
| BR_ENTRY | 0x01 | 上线广播 | UDP |
| BR_EXIT | 0x02 | 下线广播 | UDP |
| ANS_ENTRY | 0x03 | 上线应答 | UDP |
| BR_ABSENCE | 0x04 | 状态变更 | UDP |
| SENDMSG | 0x20 | 发送消息 | TCP |
| RECVMSG | 0x21 | 消息确认 | TCP |
| READMSG | 0x30 | 已读确认 | TCP |
| GETFILEDATA | 0x60 | 请求文件数据 | TCP |
| RELEASEFILES | 0x61 | 文件传输通知 | TCP |
| GETPUBKEY | 0x72 | 获取公钥 | TCP |
| ANSPUBKEY | 0x73 | 返回公钥 | TCP |

### 选项标志

| 标志 | 值 | 说明 |
|------|-----|------|
| ABSENCEOPT | 0x100 | 离线状态 |
| SERVEROPT | 0x200 | 服务器模式 |
| FILEATTACHOPT | 0x200000 | 文件附件 |
| ENCRYPTOPT | 0x400000 | 加密支持 |
| UTF8OPT | 0x800000 | UTF-8 编码 |
| SENDCHECKOPT | 0x100 | 需要发送确认 |
| SECRETOPT | 0x200 | 秘密消息 |
| READCHECKOPT | 0x100000 | 需要已读确认 |

### 用户发现流程

```
启动应用
    ↓
发送 BR_ENTRY (UDP 广播到 255.255.255.255:2425)
    ↓
监听 UDP 2425 端口
    ↓
收到其他用户的 BR_ENTRY
    ↓
回复 ANS_ENTRY (UDP 单播)
    ↓
添加用户到在线列表
    ↓
定时发送心跳 (每60秒 BR_ABSENCE)
    ↓
收到 BR_EXIT → 从列表移除
```

### 消息发送流程

```
用户输入消息
    ↓
建立 TCP 连接到对方 IP:2425
    ↓
发送 SENDMSG 包 (command | SENDCHECKOPT)
    ↓
等待 RECVMSG 确认 (超时3秒)
    ↓
收到确认 → 标记为已送达
    ↓
关闭 TCP 连接
```

### 文件传输流程

```
发送方:
1. 发送 SENDMSG (command | FILEATTACHOPT, payload=文件信息)
2. 等待接收方请求
3. 收到 GETFILEDATA → 分块发送文件数据 (64KB/块)
4. 发送完成 → RELEASEFILES

接收方:
1. 收到 SENDMSG with FILEATTACHOPT
2. 显示接收对话框
3. 用户确认 → 发送 GETFILEDATA
4. 接收文件块,显示进度
5. 完成 → 保存文件
```

### 断点续传

- 文件传输时记录 `offset`(已传输字节数)
- 中断后重新连接,发送 `GETFILEDATA` 时携带 `offset`
- 发送方从 `offset` 位置继续发送
- 使用 SwiftData 持久化传输记录

## 数据流

```
用户操作 (UI Event)
    ↓
ViewModel (@Observable)
    ↓
Service Layer (MessageService, DiscoveryService)
    ↓
Protocol Layer (UDPDiscoveryService, TCPMessenger)
    ↓
Network (UDP/TCP Socket)
    ↓
接收响应
    ↓
Decode Packet (IPMsgPacket)
    ↓
Save to SwiftData (ModelContext)
    ↓
UI 自动更新 (@Query)
```

## 错误处理

### 错误类型

- `invalidEncoding`: 数据包编码错误
- `malformedPacket`: 数据包格式不正确
- `networkUnavailable`: 网络不可用
- `connectionTimeout`: 连接超时(3秒)
- `noAcknowledgment`: 未收到确认
- `encryptionFailed`: 加密/解密失败
- `fileTransferFailed`: 文件传输失败

### 边界情况

1. **网络切换**: 监听 NWPathMonitor,网络恢复时重新广播上线
2. **离线消息**: 发送失败的消息加入队列,5秒后重试,最多3次
3. **IP 变化**: 检测到本地 IP 变化时重新广播 BR_ENTRY
4. **用户超时**: 60秒未收到心跳标记为离线,180秒后从列表移除
5. **编码兼容**: 支持 UTF-8 和 GBK 编码自动检测(兼容 FeiQ)
6. **协议版本**: 同时支持 IPMsg v1 和 v3,自动降级

## 测试策略

### 1. 单元测试 (每个模块独立测试)

- **IPMsgProtocol**: 数据包编解码、命令字解析
- **FluxQModels**: SwiftData 模型创建和关系
- **FluxQServices**: 业务逻辑、错误处理

### 2. 集成测试

- 模拟两个客户端的消息收发
- 文件传输完整流程
- 用户发现和在线状态同步

### 3. UI 测试

- 关键用户流程(发送消息、接收消息、文件传输)
- 不同平台的 UI 适配

### 4. 性能测试

- 10000+ 消息列表渲染性能
- 100+ 在线用户列表性能
- 大文件传输(1GB+)内存占用

### 5. 互操作性测试

- 与原版 FeiQ (Windows) 互操作
- 与其他 IPMsg 客户端互操作
- 不同编码格式(UTF-8/GBK)兼容性

## 版本迭代计划

FluxQ v1.0.0 将分 10 个迭代版本完成:

- **v0.1.0**: 项目基础(App Shell, SwiftData, 导航)
- **v0.2.0**: 局域网发现(UDP 广播)
- **v0.3.0**: 一对一聊天(TCP 消息)
- **v0.4.0**: 群聊
- **v0.5.0**: 文件传输
- **v0.6.0**: 截图与图片消息
- **v0.7.0**: 联系人管理与设置
- **v0.8.0**: 系统集成(托盘、通知、搜索)
- **v0.9.0**: 可靠性与安全(离线消息、加密)
- **v1.0.0**: 发布候选(跨平台测试、FeiQ 互操作验证)

详细的每个版本任务见 `docs/plans/v*.md` 文件。

## 平台特性

### macOS

- **窗口管理**: 三栏布局,记住窗口位置和大小
- **系统托盘**: 最小化到托盘,显示未读角标
- **菜单栏**: 快速操作(新消息、偏好设置)
- **开机启动**: Launch Agent 自动启动
- **快捷键**: 截图(⇧⌘5)、新消息(⌘N)

### iOS/iPadOS

- **后台刷新**: Background Modes 接收消息
- **推送通知**: Local Notifications (v1.0.0 使用本地通知)
- **分享扩展**: 从相册/文件应用分享到 FluxQ
- **iPad 多任务**: 支持 Split View 和 Slide Over
- **Dynamic Island**: 文件传输进度(iPhone 14 Pro+)

### watchOS

- **轻量级界面**: 仅显示最近消息通知
- **快速回复**: 预设消息、表情、听写
- **Complications**: 表盘显示未读数
- **Watch Connectivity**: 与 iPhone 实时同步

## 未来路线图(v2.0.0+)

- **v2.0.0**: OpenClaw AI 助手集成
- **v3.0.0**: 多 LLM 聊天机器人平台
- **v4.0.0**: 云端 IM (混合 LAN/Server 模式)

## 参考资料

- [IPMsg 原始实现](https://github.com/shirouzu/ipmsg)
- [Sky Flux IM 设计文档](/Users/martinadamsdev/workspace/sky_flux_im/docs)
- [Apple HIG - SwiftUI](https://developer.apple.com/design/human-interface-guidelines/swiftui)
- [Network.framework 文档](https://developer.apple.com/documentation/network)
- [SwiftData 文档](https://developer.apple.com/documentation/swiftdata)

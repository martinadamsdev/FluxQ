# FluxQ - 产品路线图

## 项目概述

FluxQ 是一款使用 Swift 和 SwiftUI 开发的跨平台即时通讯应用,支持 Apple 全平台(macOS、iOS、iPadOS、watchOS)。

### 版本规划

- **v1.0.0**: 局域网即时通讯 - 完整的飞秋(FeiQ)功能,P2P 无服务器通信
- **v2.0.0**: OpenClaw AI 助手集成 - 连接本地或远程 OpenClaw AI 平台
- **v3.0.0**: 多 LLM 聊天机器人平台 - 可插拔的 LLM 提供商(Anthropic, OpenAI 等)
- **v4.0.0**: 云端即时通讯 - MessageRouter 抽象,局域网中继,远程 IM Server 集成

### 技术栈

| 层级 | 技术选择 | 版本要求 |
|------|---------|---------|
| UI 框架 | SwiftUI | macOS 14+, iOS 17+ |
| 数据持久化 | SwiftData + CloudKit | macOS 14+, iOS 17+ |
| 网络层 | Network.framework + BSD Socket | 原生支持 |
| 状态管理 | @Observable | 原生支持 |
| 并发 | Swift Concurrency | 原生支持 |
| 路由 | NavigationStack | iOS 16+ |
| 协议 | IPMsg (端口 2425) | 自定义实现 |

### 系统版本要求

- **macOS**: 14 (Sonoma) 或更高
- **iOS**: 17 或更高
- **iPadOS**: 17 或更高
- **watchOS**: 10 或更高

### 项目结构

```
FluxQ/
├── App/
│   ├── FluxQ/                 # macOS/iOS/iPadOS 主应用
│   └── FluxQWatch/            # watchOS 应用
├── Modules/                    # 本地 Swift Packages
│   ├── IPMsgProtocol/         # IPMsg 协议实现
│   ├── FluxQModels/           # SwiftData 数据模型
│   ├── FluxQServices/         # 业务服务层
│   └── FluxQUI/               # 共享 UI 组件
└── Tests/                      # 集成测试
```

---

## v1.0.0 - 局域网即时通讯 (LAN IM)

完整的飞秋(FeiQ)功能。无服务器架构,使用 UDP 广播进行发现,TCP 进行消息传输,全部在局域网内完成。

分为 10 个增量版本从 v0.1.0 到 v1.0.0,每个版本都是可用的检查点。

---

### v0.1.0 - 项目基础

应用外壳,导航,数据库和核心基础设施。还没有网络功能,但应用可以启动和导航。

| # | 任务 | 说明 |
|---|------|------|
| 0.1.1 | 创建 Xcode 项目 | SwiftUI 多平台项目,设置 App targets |
| 0.1.2 | 配置 SwiftData | 定义数据模型 schema,配置 ModelContainer |
| 0.1.3 | 设置项目结构 | 创建 Modules 目录,添加 Swift Packages |
| 0.1.4 | 主界面导航 | TabView 四个标签(消息/通讯录/发现/我) |
| 0.1.5 | 基础主题系统 | 支持浅色/深色模式,主题颜色 |
| 0.1.6 | 数据模型定义 | User, Message, Conversation, Group, FileTransfer |

**交付物**: 应用启动,可以在标签间导航,数据库就绪。

---

### v0.2.0 - 局域网发现

同一局域网内的用户可以看到彼此。核心网络层开始工作。

| # | 任务 | 说明 |
|---|------|------|
| 0.2.1 | IPMsg 协议实现 | IPMsgPacket 编解码,命令字定义 |
| 0.2.2 | UDP 广播服务 | 启动时发送 ENTRY,监听 2425 端口 ENTRY/EXIT |
| 0.2.3 | 用户发现 Provider | @Observable DiscoveryService,管理在线用户列表 |
| 0.2.4 | 平台网络工具 | 获取本地 IP,子网掩码,广播地址 |
| 0.2.5 | 在线用户 UI | 显示发现的局域网用户(昵称/IP/状态/部门) |
| 0.2.6 | 用户状态管理 | 支持在线/忙碌/离开状态,广播状态变更 |

**交付物**: 在同一局域网的两台设备上打开应用,它们会自动发现彼此。

---

### v0.3.0 - 一对一聊天

两个用户可以相互发送文本消息。核心 IM 体验可用。

| # | 任务 | 说明 |
|---|------|------|
| 0.3.1 | TCP 消息服务 | TCP listener 监听消息,TCP client 发送消息 |
| 0.3.2 | 消息模型与存储 | Message SwiftData 模型,状态管理 |
| 0.3.3 | 会话列表 UI | 按最后消息时间排序的会话列表 |
| 0.3.4 | 聊天详情 UI | 消息气泡,输入栏,发送按钮,滚动到底部 |
| 0.3.5 | 消息状态 | 发送中/已送达/已读指示器,TCP ACK 已读回执 |
| 0.3.6 | 表情支持 | 表情选择器集成到聊天输入 |

**交付物**: 两个用户可以通过局域网进行实时文本对话。

---

### v0.4.0 - 群聊

多个用户可以在群组中聊天。

| # | 任务 | 说明 |
|---|------|------|
| 0.4.1 | 群组模型与存储 | Group SwiftData 模型(id/name/creator/members) |
| 0.4.2 | 群组创建流程 | 从联系人选择成员,设置群组名称,广播群组信息 |
| 0.4.3 | 群组消息传输 | 通过 TCP 向所有群组成员组播消息 |
| 0.4.4 | 群组管理 | 添加/移除成员,重命名群组,解散群组 |
| 0.4.5 | 群聊 UI | 复用聊天 UI,显示群组成员头像和名称 |

**交付物**: 创建一个有 3+ 用户的群组,所有人可以发送和接收群组消息。

---

### v0.5.0 - 文件传输

用户可以通过局域网发送和接收文件和文件夹。

| # | 任务 | 说明 |
|---|------|------|
| 0.5.1 | 文件传输协议 | 基于 TCP 的分块传输(64KB),进度跟踪 |
| 0.5.2 | 发送文件流程 | 文件选择器,发起传输请求,等待接受 |
| 0.5.3 | 接收文件流程 | 接受/拒绝对话框,下载到指定位置 |
| 0.5.4 | 文件夹传输 | 基于 Zip 的目录传输,接收时自动解压 |
| 0.5.5 | 断点续传 | 基于偏移量的中断传输恢复 |
| 0.5.6 | 传输历史 | 已完成/进行中传输列表,过滤标签 |

**交付物**: 在两台设备间发送 100MB 文件,显示进度,成功接收。恢复中断的传输。

---

### v0.6.0 - 截图与媒体

用户可以捕获截图并在聊天中发送图片。

| # | 任务 | 说明 |
|---|------|------|
| 0.6.1 | 截图捕获 | 平台特定截图(桌面:窗口/区域,移动:系统截图) |
| 0.6.2 | 截图预览与发送 | 预览捕获的图片,裁剪/标注,在聊天中发送 |
| 0.6.3 | 图片消息渲染 | 聊天中内联显示图片(缩略图+全屏查看) |
| 0.6.4 | 剪贴板粘贴 | 从剪贴板直接粘贴图片到聊天 |

**交付物**: 截取屏幕截图,预览,在聊天中发送,接收方内联看到图片。

---

### v0.7.0 - 联系人与设置

完整的联系人管理,用户资料和应用设置。

| # | 任务 | 说明 |
|---|------|------|
| 0.7.1 | 联系人分组 | 创建自定义组/部门,分配联系人 |
| 0.7.2 | 联系人详情视图 | 显示用户信息/IP/状态/消息历史快捷方式 |
| 0.7.3 | 用户资料设置 | 设置昵称/部门/默认状态/头像 |
| 0.7.4 | 自动回复 | 配置离开/忙碌状态的自动回复消息 |
| 0.7.5 | 通知设置 | 声音/桌面通知/勿扰模式 |
| 0.7.6 | 主题设置 | 浅色/深色模式/强调色 |

**交付物**: 将联系人组织到部门,自定义资料,在浅色/深色主题间切换。

---

### v0.8.0 - 系统集成

桌面托盘,原生通知,声音提醒和消息搜索。

| # | 任务 | 说明 |
|---|------|------|
| 0.8.1 | 系统托盘(桌面) | 最小化到托盘,带未读角标的托盘图标 |
| 0.8.2 | 桌面通知 | 新消息的原生 OS 通知 |
| 0.8.3 | 移动通知 | 后台消息的本地通知 |
| 0.8.4 | 声音提醒 | 可配置的通知声音 |
| 0.8.5 | 应用启动 | 自动启动选项,记住窗口位置(桌面) |
| 0.8.6 | 消息搜索 | 跨所有会话的全文搜索 |

**交付物**: 应用驻留系统托盘,显示原生通知,搜索可以找到所有聊天中的消息。

---

### v0.9.0 - 可靠性与安全

离线消息处理,加密和健壮性改进。

| # | 任务 | 说明 |
|---|------|------|
| 0.9.1 | 离线消息队列 | 为离线用户排队消息,重新连接时重发 |
| 0.9.2 | 消息加密 | 敏感会话的可选 AES 加密 |
| 0.9.3 | 错误处理 | 网络断开恢复,优雅降级 |
| 0.9.4 | 连接弹性 | 网络变化时自动重连,处理 IP 变化 |

**交付物**: 向离线用户发送消息,他们上线后会收到。加密聊天可用。

---

### v1.0.0 - 发布候选

最终测试,性能调优和飞秋互操作性验证。

| # | 任务 | 说明 |
|---|------|------|
| 1.0.1 | 跨平台测试 | 在 macOS/iOS/iPadOS/watchOS 上测试 |
| 1.0.2 | 飞秋互操作测试 | 验证与原版飞秋客户端的协议兼容性 |
| 1.0.3 | 性能优化 | 消息列表虚拟化/图片缓存/内存分析 |
| 1.0.4 | UI 打磨 | 动画/过渡/不同屏幕尺寸的响应式布局 |
| 1.0.5 | 发布构建 | 配置签名,为所有平台构建发布二进制文件 |
| 1.0.6 | E2E 测试 | 端到端测试套件(22个测试覆盖核心流程) |
| 1.0.7 | 文档 | 用户指南/构建说明/协议文档 |

**交付物**: 生产就绪的局域网即时通讯,完整的飞秋功能,在所有平台测试通过。

---

## v2.0.0 - OpenClaw 集成

将 FluxQ 连接到 OpenClaw AI 助手平台,支持本地和远程实例。

分为 v1.1.0 → v2.0.0 (9 个增量版本)。

---

### v1.1.0 - WebSocket 客户端

健壮,可复用的 WebSocket 客户端库 - 所有基于服务器功能的基础。

**交付物**: 带自动重连/心跳/连接状态流的 WebSocket 客户端。

### v1.2.0 - OpenClaw 连接

协议适配器,连接设置 UI 和 OpenClaw Gateway 认证。

**交付物**: 连接到本地或远程 OpenClaw,带状态指示器和认证。

### v1.3.0 - AI 会话模型

扩展数据模型以支持带角色和令牌跟踪的 AI 类型会话。

**交付物**: AI 会话出现在会话列表中,带机器人图标。

### v1.4.0 - AI 聊天 UI

核心 AI 聊天界面,带流式响应/输入指示器/停止生成。

**交付物**: 与 AI 聊天,逐字看到流式响应。

### v1.5.0 - Markdown 渲染

AI 响应的完整 markdown 支持 - 代码块/表格/列表/链接。

**交付物**: 带复制按钮的语法高亮代码块/表格/流式 markdown。

### v1.6.0 - 上下文管理与群组 AI

令牌跟踪/自动截断/系统提示/群聊中的 @AI。

**交付物**: 带 @AI 群组提及的上下文感知 AI 聊天。

### v1.7.0 - 工具发现与面板

获取并在分类的可搜索面板中显示可用的 OpenClaw 工具。

**交付物**: 按类别浏览工具/搜索/查看详情/管理收藏。

### v1.8.0 - 工具调用与结果

从面板或聊天调用工具,以特殊消息气泡形式内联渲染结果。

**交付物**: 执行工具,在聊天中内联看到结果(文本/图片/代码/数据)。

### v1.9.0 - 错误处理与性能

错误处理/边界情况/性能优化/会话管理。

**交付物**: 带优雅降级和 60fps 流式的健壮 AI 集成。

### v2.0.0 - OpenClaw 发布

引导/使用统计/跨平台测试/发布打磨。

**交付物**: 生产就绪的 OpenClaw AI 助手集成。

---

## v3.0.0 - 多 LLM 聊天机器人平台

可插拔的 LLM 架构,允许由任何主流模型提供商驱动的聊天机器人。

分为 v2.1.0 → v3.0.0 (10 个增量版本)。

---

### v2.1.0 - LLM 抽象与 Ollama

可插拔的 LlmProvider 接口 + 第一个提供商(本地 Ollama)。

**交付物**: 通过可插拔架构与本地 Ollama 模型聊天。

### v2.2.0 - 云端 LLM 提供商

添加 Anthropic (Claude)/OpenAI (GPT) 和三个中国提供商。

**交付物**: 通过统一接口与 Claude/GPT/Doubao/GLM/Kimi 聊天。

### v2.3.0 - 中国 LLM 提供商

专门为中国市场 LLM 发布,带优化配置。

**交付物**: Volcengine/Zhipu/Moonshot 提供商,带统一测试套件。

### v2.4.0 - 提供商管理器与配置

集中管理/安全 API 密钥存储/Ollama 自动发现。

**交付物**: 提供商设置 UI/连接测试/默认提供商选择。

### v2.5.0 - 机器人模型与创建

ChatBot 数据模型和带系统提示模板的分步创建向导。

**交付物**: 通过引导向导使用提供商/模型/提示创建机器人。

### v2.6.0 - 机器人列表与联系人

机器人管理 UI 和作为虚拟联系人集成到联系人列表。

**交付物**: 带编辑/复制/导出的机器人列表,联系人列表中"AI 助手"下的机器人。

### v2.7.0 - 机器人对话

与机器人的完整聊天体验 - 流式/重新生成/模型切换。

**交付物**: 与机器人聊天/重新生成响应/对话中切换模型。

### v2.8.0 - 群组机器人与对比

添加机器人到群聊/多模型对比视图。

**交付物**: 在群组中 @提及机器人/并排对比 2-4 个模型。

### v2.9.0 - 导出与令牌跟踪

会话导出(MD/PDF/JSON)/令牌使用仪表板/预算提醒。

**交付物**: 导出会话/跟踪使用成本/预算通知。

### v3.0.0 - 多 LLM 发布

自定义提供商插件/模型市场/跨平台打磨。

**交付物**: 生产就绪的多 LLM 聊天机器人平台。

---

## v4.0.0 - 云端即时通讯

将 FluxQ 从仅局域网 P2P 转变为支持局域网和基于云服务器消息的混合 IM 客户端。引入用于可插拔传输的 `MessageRouter` 抽象。

分为 v3.1.0 → v4.0.0 (10 个增量版本)。配套文档: 待补充。

---

### v3.1.0 - MessageRouter 抽象

定义抽象路由接口,从现有代码中提取 P2PRouter。纯重构。

**交付物**: 所有现有功能通过 MessageRouter 工作,零行为变化。

### v3.2.0 - 局域网中继选举

大型局域网组的基于 UDP 的中继节点选举协议。

**交付物**: 5秒内完成中继选举,节点故障时重新选举。

### v3.3.0 - RelayRouter 与自动切换

RelayRouter 实现,带基于阈值的 P2P ↔ 中继自动切换。

**交付物**: 通过中继的 500 成员局域网组/< 200ms 传递/自动故障转移。

### v3.4.0 - 连接模式设置

局域网/服务器/混合模式的设置 UI,带服务器配置文件管理和二维码配置。

**交付物**: 切换模式/管理服务器配置文件/扫描二维码配置。

### v3.5.0 - 服务器 WebSocket 客户端

WebSocket 上的二进制协议/Protobuf 消息/TLS/连接质量监控。

**交付物**: 带二进制协议和延迟跟踪的生产 WebSocket 客户端。

### v3.6.0 - 服务器认证

JWT 登录/令牌刷新/设备注册/OAuth2 支持。

**交付物**: 登录到 IM Server/管理设备/OAuth2 第三方登录。

### v3.7.0 - ServerRouter

通过服务器路由消息/离线队列/通过 CDN 的服务器端文件传输。

**交付物**: 通过服务器发送/接收消息/重新连接时离线队列排空。

### v3.8.0 - 混合模式

服务器主导 + 本地对等点间文件传输的局域网加速。

**交付物**: 本地对等点的局域网加速/无缝局域网↔服务器故障转移。

### v3.9.0 - 多设备同步与推送

基于序列的多设备同步/推送通知(APNs/FCM/厂商通道)。

**交付物**: 3 台设备保持同步/iOS 和 Android 上的推送通知。

### v4.0.0 - 云端 IM 发布

富媒体/消息搜索/资料/在线状态/跨平台测试/打磨。

**交付物**: 生产就绪的云端 IM,带混合局域网/服务器模式。

---

## 版本总结

### v1.0.0 进度 (局域网 IM)

| 版本 | 主题 | 关键交付物 |
|---------|-------|-----------------|
| v0.1.0 | 项目基础 | 应用启动/导航/数据库就绪 |
| v0.2.0 | 局域网发现 | 同一局域网设备发现彼此 |
| v0.3.0 | 一对一聊天 | 两用户实时文本对话 |
| v0.4.0 | 群聊 | 多用户群组消息带 @提及 |
| v0.5.0 | 文件传输 | P2P 文件/文件夹传输带续传 |
| v0.6.0 | 截图与媒体 | 捕获并在聊天中发送图片 |
| v0.7.0 | 联系人与设置 | 联系人管理/资料/主题 |
| v0.8.0 | 系统集成 | 托盘/通知/搜索 |
| v0.9.0 | 可靠性与安全 | 离线消息/加密 |
| v1.0.0 | 发布 | 跨平台测试/飞秋兼容 |

### 主要版本目标

| 版本 | 目标 | 关键交付物 |
|---------|--------|-----------------|
| v1.0.0 | 局域网 IM | 完整的飞秋兼容局域网即时通讯 |
| v2.0.0 | AI 助手 | OpenClaw AI 集成带工具支持 |
| v3.0.0 | 聊天机器人平台 | 多 LLM 机器人(Ollama/Claude/GPT/中国 LLM) |
| v4.0.0 | 云端 IM | 跨网络 IM 带十亿级服务器架构 |

---

## 发布流程

### 版本完成清单

每个版本(v0.1.0 → v4.0.0)完成时,必须执行以下流程:

```
1. ✅ 所有代码通过测试
   └── swift test (100% 通过,覆盖率达标)

2. ✅ 更新文档
   ├── CHANGELOG.md (按 Keep a Changelog 格式)
   ├── README.md (如有新功能影响)
   └── docs/plans/vX.Y.0.md — Verification 清单全部勾选

3. ✅ 更新版本号
   └── FluxQ.xcodeproj: Marketing Version X.Y.0

4. ✅ Git Commit & Tag
   ├── git commit (最后一个 commit 为版本提交)
   └── git tag vX.Y.0

5. ✅ Push & CI
   ├── git push origin main --tags
   └── GitHub Actions 全部通过(test + build)

6. ✅ 里程碑版本额外步骤(见下方)
```

### Git Tag 约定

- Tag 格式: `vMAJOR.MINOR.PATCH` (严格语义化版本)
- Tag 必须在 CI 全部通过后打
- Tag push 触发 GitHub Actions Release 工作流

### 里程碑发布

以下 4 个里程碑版本需要创建 **GitHub Release** 并附带构建产物:

| 里程碑 | 版本 | Release 内容 |
|--------|------|-------------|
| LAN IM 正式版 | v1.0.0 | macOS/iOS/iPadOS/watchOS 构建产物 |
| OpenClaw AI 集成 | v2.0.0 | 全平台构建 + AI 功能演示截图 |
| Multi-LLM ChatBot | v3.0.0 | 全平台构建 + 多模型对比演示 |
| Cloud IM 正式版 | v4.0.0 | 全平台构建 + 服务端部署文档链接 |

**Release 流程**:

```
1. 确认所有 Verification 清单通过
2. 创建 GitHub Release (tag: vX.0.0)
3. Release Notes = CHANGELOG.md 对应版本内容
4. 附件:各平台构建产物
   ├── macOS:   FluxQ-vX.0.0-macos.dmg
   ├── iOS:     TestFlight 链接 (或 IPA)
   ├── iPadOS:  TestFlight 链接 (或 IPA)
   └── watchOS: 通过 iOS 应用分发
5. 标记为 Latest Release
```

### 非里程碑版本

非里程碑版本(如 v0.6.0/v1.3.0/v2.4.0 等):

- **Git tag**: 必须
- **CI 通过**: 必须
- **GitHub Release**: 不需要(仅 tag)
- **构建产物**: CI 中构建验证通过即可,不需要分发

---

## 开发原则

### YAGNI (You Aren't Gonna Need It)

- 只实现当前版本需要的功能
- 不要为未来版本预先设计架构
- 每个版本都是可用的独立产品

### 增量交付

- 每个版本都可以独立使用
- 后续版本基于前一版本增强
- 保持向后兼容

### 测试驱动

- 单元测试覆盖核心逻辑
- 集成测试验证端到端流程
- UI 测试确保用户体验

### 文档优先

- 每个版本都有完整的文档
- API 文档自动生成
- 用户指南与代码同步更新

---

## 参考资料

- **设计文档**: [2026-02-13-fluxq-v1.0.0-design.md](./2026-02-13-fluxq-v1.0.0-design.md)
- **协议分析**: [../ipmsg.md](../ipmsg.md)
- **IPMsg 原始实现**: [shirouzu/ipmsg](https://github.com/shirouzu/ipmsg)
- **Apple HIG**: [SwiftUI Guidelines](https://developer.apple.com/design/human-interface-guidelines/swiftui)

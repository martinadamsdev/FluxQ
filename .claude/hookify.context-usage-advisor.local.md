---
name: context-usage-advisor
enabled: true
event: prompt
pattern: (上下文|context).*(使用率|usage|多少|情况|状态|how much)|查看.*上下文|check.*context|context.*status
action: warn
---

## 📊 上下文使用率分析顾问

当你提到查看或询问上下文使用情况时,这里是分析建议。

**注意**: 由于 `/context` 是系统内置命令,hookify 无法直接捕获。如需触发此建议,可以在执行 `/context` 后询问 "当前上下文使用情况如何?"

### 使用率分析与建议 (基于 200K tokens)

#### < 50% (< 100K tokens) — 充裕

- **状态**: 上下文空间充足
- **建议**: 正常工作,无需特别关注
- 可以自由进行代码搜索、文件读取等操作
- 适合处理复杂的多步骤任务

#### 50-70% (100K-140K tokens) — 良好

- **状态**: 使用正常,开始留意
- **建议**:
  - 继续正常工作
  - 大型搜索任务考虑使用 Subagents
  - 完成当前阶段后可选择性 compact

#### 70-85% (140K-170K tokens) — 注意

- **状态**: 使用较多,应主动管理
- **建议**:
  - 将重要信息保存到 MEMORY.md
  - 使用 Subagents 处理独立的搜索/分析任务
  - 完成当前任务后运行 `/compact`
  - 避免读取大文件全文,使用 offset/limit 参数

#### 85-90% (170K-180K tokens) — 警告

- **状态**: 接近上限,需要立即管理
- **行动清单**:
  - [ ] 保存当前任务状态到 MEMORY.md
  - [ ] 检查并更新 TaskList 中的任务状态
  - [ ] 运行 `/compact` 压缩历史
  - [ ] 精简后续操作,避免大段输出

#### 90-95% (180K-190K tokens) — 紧急

- **状态**: 高风险,可能影响响应质量
- **行动清单**:
  - [ ] 立即保存所有未完成的工作状态
  - [ ] 立即运行 `/compact`
  - [ ] 如果 compact 后仍 > 85%,准备重启 session
  - [ ] 通知用户当前状况

#### > 95% (> 190K tokens) — 危急

- **状态**: 必须立即处理,否则可能丢失上下文
- **行动**: 停止一切工作,立即执行以下步骤:
  1. 保存所有状态到文件 (MEMORY.md, TODO.md)
  2. 提交或暂存 git 更改
  3. 运行 `/compact`
  4. 如果仍然不够,保存后重启新 session

---

### 🔧 快速优化建议

**降低上下文消耗的方法**:
- 使用 `Glob` 和 `Grep` 替代大范围文件读取
- 使用 `Read` 的 `offset`/`limit` 参数只读取需要的部分
- 将独立的搜索/分析任务委托给 Subagents
- 编辑文件时使用精确的 `Edit` 而非 `Write` 全文覆写
- 避免重复读取已经读过的文件

**定期维护**:
- 每完成一个大任务后运行 `/compact`
- 关键信息及时写入持久化存储 (MEMORY.md)
- 使用 `/context` 定期监控使用率
